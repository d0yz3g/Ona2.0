# Telegram-бот Она на базе aiogram 3

Бот-помощник для проведения психологического опроса, создания профиля пользователя и предоставления рекомендаций.

## Основные функции

1. Проведение опроса с 5 демо-вопросами и 34 вопросами о сильных сторонах пользователя
2. Создание профиля на основе ответов с категоризацией сильных сторон
3. Генерация психологических рекомендаций с помощью OpenAI
4. Создание натальной карты на основе даты и места рождения
5. Отправка голосовых медитаций
6. Управление напоминаниями

## Структура проекта

- `main.py` - основной файл приложения
- `db.py` - работа с SQLite базой данных
- `questions.py` - вопросы для опроса
- `states.py` - определение состояний FSM
- `handlers/` - обработчики команд и сообщений:
  - `questionnaire.py` - опросник с использованием FSM
  - `meditate.py` - голосовые медитации
  - `recs.py` - рекомендации на основе OpenAI
  - `reminders.py` - система напоминаний
- `services/` - сервисные модули:
  - `ai_client.py` - интеграция с OpenAI
  - `astrology.py` - расчет натальной карты
  - `recs.py` - генерация рекомендаций
  - `scheduler.py` - планировщик напоминаний
  - `tts.py` - генерация голосовых сообщений

## Устранённые ошибки

В ходе разработки были исправлены следующие проблемы:

1. **Добавлены категории к вопросам о сильных сторонах**
   - В `questions.py` добавлено поле `category` ко всем вопросам о сильных сторонах
   - Категории: analytical, creative, leadership, social, organized, resilient

2. **Обновлены импорты в модуле services**
   - В `services/__init__.py` добавлены импорты всех необходимых модулей

3. **Исправлена функция `make_natal_chart`**
   - Функция теперь принимает третий параметр `name`
   - Добавлен параметр `name` в возвращаемые словари

4. **Установлены необходимые зависимости**
   - apscheduler - для планировщика напоминаний
   - ephem - для астрологических расчетов
   - httpx - для асинхронных HTTP-запросов
   - openai - для работы с OpenAI API
   - aiofiles - для асинхронной работы с файлами
   - python-dotenv - для загрузки переменных окружения

## Установка и запуск

1. Клонировать репозиторий:
   ```
   git clone <url_репозитория>
   ```

2. Установить зависимости:
   ```
   pip install -r requirements.txt
   ```

3. Создать .env файл с переменными окружения:
   ```
   BOT_TOKEN=ваш_токен_бота
   OPENAI_API_KEY=ваш_api_ключ_openai
   ELEVEN_API_KEY=ваш_api_ключ_elevenlabs
   ```

4. Запустить бота:
   ```
   python main.py
   ```

## Команды бота

- `/start` - Начать взаимодействие с ботом
- `/help` - Показать справочную информацию
- `/profile` - Показать профиль или начать опрос для его создания
- `/questionnaire`, `/begin` - Начать опрос
- `/reflect` - Получить психологический совет
- `/help_reflect` - Справка по получению советов
- `/meditate` - Получить голосовую медитацию
- `/help_meditate` - Справка по медитациям
- `/reminder_on` - Включить ежедневные напоминания
- `/reminder_off` - Отключить напоминания
- `/reminder_status` - Проверить статус напоминаний
- `/help_reminder` - Справка по напоминаниям
- `/cancel` - Прервать текущий опрос

## Технический стек

- **Язык:** Python 3.11+
- **Framework:** aiogram 3.x
- **База данных:** SQLite
- **AI-интеграции:** OpenAI API
- **Голосовой синтез:** ElevenLabs TTS API
- **Планировщик:** APScheduler
- **Контейнеризация:** Docker

## Структура проекта

```
ona_bot/
├── main.py              # Точка входа в приложение
├── db.py                # Работа с базой данных
├── handlers.py          # Основные обработчики команд и опроса
├── handlers/            # Модульные обработчики
│   ├── __init__.py
│   ├── recs.py          # Обработчики рекомендаций
│   ├── meditate.py      # Обработчики медитаций
│   ├── reminders.py     # Обработчики напоминаний
├── services/            # Сервисные модули
│   ├── __init__.py
│   ├── ai_client.py     # Клиент для OpenAI API
│   ├── astrology.py     # Астрологические расчеты
│   ├── recs.py          # Генерация рекомендаций
│   ├── tts.py           # Генерация голоса через ElevenLabs
│   ├── scheduler.py     # Планировщик напоминаний
├── tmp/                 # Временные файлы
├── tests/               # Тесты
├── docs/                # Документация
├── .env                 # Переменные окружения (не включено в репозиторий)
├── .env.example         # Пример переменных окружения
├── requirements.txt     # Зависимости проекта
├── Dockerfile           # Для сборки контейнера
└── .dockerignore        # Исключения для Docker
```

## Локальная разработка

### Подготовка

1. Клонировать репозиторий:
   ```bash
   git clone https://github.com/ваш-репозиторий/ona-bot.git
   cd ona-bot
   ```

2. Создать виртуальное окружение и установить зависимости:
   ```bash
   python -m venv venv
   source venv/bin/activate  # или venv\Scripts\activate в Windows
   pip install -r requirements.txt
   ```

3. Создать файл `.env` на основе `.env.example` и заполнить необходимые переменные:
   ```
   BOT_TOKEN=ваш_токен_бота
   OPENAI_API_KEY=ваш_api_ключ_openai
   ELEVEN_API_KEY=ваш_api_ключ_elevenlabs
   ELEVEN_VOICE_ID=21m00Tcm4TlvDq8ikWAM
   ```

4. Запустить бота:
   ```bash
   python main.py
   ```

### Переменные окружения

| Переменная      | Описание                                       | Пример                                 |
|-----------------|------------------------------------------------|----------------------------------------|
| BOT_TOKEN       | Токен Telegram бота от @BotFather              | 1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZ |
| OPENAI_API_KEY  | Ключ API OpenAI для генерации рекомендаций     | sk-ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh |
| ELEVEN_API_KEY  | Ключ API ElevenLabs для генерации голоса       | abcdefghijklmnopqrstuvwxyz123456      |
| ELEVEN_VOICE_ID | ID голоса в ElevenLabs (женский по умолчанию)  | 21m00Tcm4TlvDq8ikWAM                   |
| PORT            | Порт для healthcheck (опционально)             | 8080                                   |

## Деплой на Railway

1. Создайте аккаунт на [Railway](https://railway.app/)

2. Подключите репозиторий:
   - Перейдите в раздел "New Project" → "Deploy from GitHub"
   - Выберите репозиторий с ботом
   - Railway автоматически определит наличие Dockerfile

3. Добавьте переменные окружения:
   - В разделе "Variables" добавьте все необходимые переменные из `.env.example`

4. Настройте healthcheck:
   - В разделе "Settings" → "Health Check" укажите URL: `/health`
   - Команда: `curl -f http://localhost:8080/health || exit 1`

5. Запустите деплой

## Мониторинг и тестирование

- Проверьте логи в разделе "Logs" на Railway
- Используйте чеклист для E2E тестирования в `tests/e2e_checklist.md`
- Для локальной проверки healthcheck: `curl http://localhost:8080/health`

## Лицензия

Проект распространяется под MIT лицензией. См. файл LICENSE для подробностей. 