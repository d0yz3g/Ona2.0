# Использование Webhook режима для Telegram бота

## Что такое Webhook и почему его стоит использовать

Telegram Bot API поддерживает два способа получения обновлений:
1. **Long Polling** - бот постоянно опрашивает Telegram API на наличие новых сообщений
2. **Webhook** - Telegram сервер сам отправляет обновления на указанный URL, когда они появляются

Преимущества Webhook:
- Более эффективное использование ресурсов (нет постоянных запросов)
- Мгновенная доставка обновлений без задержек
- Избавляет от проблемы "Conflict: terminated by other getUpdates request"
- Лучше подходит для production-окружения, особенно на хостингах вроде Railway

## Как включить режим Webhook

### 1. Настройка переменных окружения

В Railway или в локальном `.env` файле добавьте следующие переменные:

```
# Включить режим webhook
WEBHOOK_MODE=true

# URL для webhook (если не указан, будет использоваться Railway Public Domain)
WEBHOOK_URL=https://yourdomain.com/webhook/YOUR_BOT_TOKEN

# Порт для запуска веб-сервера (по умолчанию 8080 или PORT из окружения)
PORT=8080
```

Если вы размещаете бота на Railway, переменная `RAILWAY_PUBLIC_DOMAIN` будет доступна автоматически, и URL webhook будет сформирован как `https://{RAILWAY_PUBLIC_DOMAIN}/webhook/{BOT_TOKEN}`.

### 2. Запуск бота в режиме Webhook

Запустите бота обычным способом:

```bash
python start_bot.py
```

Бот автоматически:
1. Обнаружит режим webhook по переменной окружения
2. Настроит webhook URL через Telegram API
3. Запустит веб-сервер для обработки запросов

### 3. Проверка работы

Чтобы проверить, что webhook настроен правильно:

```bash
# Для просмотра текущих настроек webhook
python webhook_setup.py --info

# Для удаления webhook (переход обратно на polling)
python webhook_setup.py --remove
```

## Отладка и устранение проблем

### Проверка логов

В логах бота вы должны увидеть сообщения:
- "Режим работы: webhook"
- "Webhook успешно установлен"
- "Webhook-сервер запущен на 0.0.0.0:8080"

### Частые проблемы

1. **URL должен использовать HTTPS**
   - Telegram принимает только HTTPS URL для webhook
   - Railway и большинство хостингов предоставляют HTTPS по умолчанию

2. **Порт должен быть 80, 443, 8080 или 8443**
   - На Railway используйте порт 8080 (или переменную PORT)
   
3. **Сертификат должен быть действительным**
   - Если у вас самоподписанный сертификат, нужно указать его в настройках webhook

## Переключение обратно на режим Long Polling

Чтобы вернуться к режиму long polling:

1. Установите переменную окружения `WEBHOOK_MODE=false`
2. Удалите webhook: `python webhook_setup.py --remove`
3. Перезапустите бота: `python start_bot.py`

## Примечания

- Режим webhook рекомендуется для production-среды
- Режим long polling может быть удобнее для локальной разработки
- При использовании webhook важно настроить корректную обработку ошибок и повторных попыток 