from typing import Dict, List, Union, Tuple, Any, Optional
import logging

# Настройка логирования
logger = logging.getLogger(__name__)

# Демо-вопросы для первоначального знакомства
DEMO_QUESTIONS = [
    {
        "id": "name",
        "text": "Как тебя зовут?",
        "type": "text"
    },
    {
        "id": "age",
        "text": "Сколько тебе лет?",
        "type": "text"
    },
    {
        "id": "birthdate",
        "text": "Какая у тебя дата рождения? (формат: ДД.ММ.ГГГГ)",
        "type": "text"
    },
    {
        "id": "birthplace",
        "text": "Где ты родился/родилась? (город, страна)",
        "type": "text"
    },
    {
        "id": "timezone",
        "text": "В каком часовом поясе ты находишься? (например, UTC+3 для Москвы)",
        "type": "text"
    }
]

# Vasini Strength Constellation - 34 вопроса
VASINI_QUESTIONS = [
    {
        "id": "vasini_1",
        "text": "Какой стиль работы вам ближе?",
        "type": "choice",
        "options": {
            "A": "Люблю структурировать информацию и создавать системы",
            "B": "Предпочитаю действовать интуитивно, опираясь на внутренние ощущения",
            "C": "Стремлюсь к эффективным результатам, используя проверенные методы",
            "D": "Ищу творческие решения и новые подходы к задачам"
        }
    },
    {
        "id": "vasini_2",
        "text": "Что вас мотивирует больше всего?",
        "type": "choice",
        "options": {
            "A": "Достижение конкретных целей и видимых результатов",
            "B": "Возможность помогать другим и делать мир лучше",
            "C": "Получение новых знаний и интеллектуальное развитие",
            "D": "Свобода самовыражения и творческая реализация"
        }
    },
    {
        "id": "vasini_3",
        "text": "Как вы реагируете на сложные ситуации?",
        "type": "choice",
        "options": {
            "A": "Анализирую проблему, ищу логическое решение",
            "B": "Доверяю интуиции и внутренним ощущениям",
            "C": "Сохраняю спокойствие и ищу практический выход",
            "D": "Рассматриваю ситуацию с разных сторон, ищу необычные решения"
        }
    },
    {
        "id": "vasini_4",
        "text": "Что вам важнее в работе?",
        "type": "choice",
        "options": {
            "A": "Четкие инструкции и понятные ожидания",
            "B": "Гармоничная атмосфера и хорошие отношения в коллективе",
            "C": "Возможность проявить лидерские качества",
            "D": "Пространство для творчества и экспериментов"
        }
    },
    {
        "id": "vasini_5",
        "text": "Как вы принимаете решения?",
        "type": "choice",
        "options": {
            "A": "Опираясь на факты и логический анализ",
            "B": "Учитывая чувства и потребности всех участников",
            "C": "Взвешивая практические последствия",
            "D": "Доверяя интуиции и внутреннему голосу"
        }
    },
    {
        "id": "vasini_6",
        "text": "Что для вас наиболее ценно?",
        "type": "choice",
        "options": {
            "A": "Порядок, структура и предсказуемость",
            "B": "Гармония, глубокие отношения и внутренний баланс",
            "C": "Достижения, эффективность и конкретные результаты",
            "D": "Творчество, уникальность и аутентичность"
        }
    },
    {
        "id": "vasini_7",
        "text": "Какую роль вы обычно берете на себя в группе?",
        "type": "choice",
        "options": {
            "A": "Аналитик или эксперт, предлагающий обоснованные решения",
            "B": "Миротворец, заботящийся о гармонии и поддержке других",
            "C": "Лидер или организатор, направляющий группу к цели",
            "D": "Генератор идей, предлагающий новые подходы"
        }
    },
    {
        "id": "vasini_8",
        "text": "Что вас выводит из равновесия?",
        "type": "choice",
        "options": {
            "A": "Беспорядок, неточность и нелогичность",
            "B": "Конфликты, напряжение и бесчувственность",
            "C": "Неэффективность, отсутствие результатов",
            "D": "Рутина, ограничения и узкие рамки"
        }
    }
]

# Вторая часть вопросов Vasini Constellation
VASINI_QUESTIONS_2 = [
    {
        "id": "vasini_9",
        "text": "Как вы восстанавливаете энергию?",
        "type": "choice",
        "options": {
            "A": "Через интеллектуальную деятельность и размышления",
            "B": "Через глубокое общение или медитативные практики",
            "C": "Через физическую активность и достижение целей",
            "D": "Через творчество и новые впечатления"
        }
    },
    {
        "id": "vasini_10",
        "text": "Что вас привлекает в других людях?",
        "type": "choice",
        "options": {
            "A": "Интеллект, логика и компетентность",
            "B": "Эмпатия, искренность и глубина",
            "C": "Целеустремленность, решительность и надежность",
            "D": "Оригинальность, креативность и страсть"
        }
    },
    {
        "id": "vasini_11",
        "text": "Какое высказывание больше всего про вас?",
        "type": "choice",
        "options": {
            "A": "Я ценю точность и логику во всем",
            "B": "Для меня важно внутреннее состояние и гармония",
            "C": "Я стремлюсь к конкретным результатам и достижениям",
            "D": "Я всегда ищу новые идеи и возможности"
        }
    },
    {
        "id": "vasini_12",
        "text": "Каким образом вы обрабатываете информацию?",
        "type": "choice",
        "options": {
            "A": "Систематизирую и анализирую, выстраивая логические связи",
            "B": "Воспринимаю интуитивно, обращая внимание на эмоциональные аспекты",
            "C": "Оцениваю практическую ценность и применимость",
            "D": "Ищу необычные связи и новые смыслы"
        }
    },
    {
        "id": "vasini_13",
        "text": "Какой стиль общения вам ближе?",
        "type": "choice",
        "options": {
            "A": "Четкий, структурированный, ориентированный на факты",
            "B": "Эмпатичный, личностный, ориентированный на чувства",
            "C": "Прямой, результативный, ориентированный на действия",
            "D": "Выразительный, вдохновляющий, ориентированный на идеи"
        }
    },
    {
        "id": "vasini_14",
        "text": "Что вы считаете своей сильной стороной?",
        "type": "choice",
        "options": {
            "A": "Аналитические способности и логическое мышление",
            "B": "Эмпатию и понимание человеческих отношений",
            "C": "Эффективность и умение достигать поставленных целей",
            "D": "Креативность и способность мыслить нестандартно"
        }
    },
    {
        "id": "vasini_15",
        "text": "Что вам наиболее важно в дружбе?",
        "type": "choice",
        "options": {
            "A": "Интеллектуальная общность и уважение к личному пространству",
            "B": "Эмоциональная поддержка и глубокая взаимная связь",
            "C": "Надежность, честность и взаимная польза",
            "D": "Вдохновение, принятие и свобода самовыражения"
        }
    },
    {
        "id": "vasini_16",
        "text": "Какой подход к обучению вам ближе?",
        "type": "choice",
        "options": {
            "A": "Структурированный, с акцентом на теорию и глубокое понимание",
            "B": "Интерактивный, учитывающий личные ценности и переживания",
            "C": "Практический, ориентированный на конкретные навыки и результаты",
            "D": "Экспериментальный, с пространством для самостоятельных открытий"
        }
    }
]

# Функции для получения вопросов
def get_demo_questions() -> List[Dict[str, Union[str, List[str]]]]:
    """
    Получение списка демо-вопросов.
    
    Returns:
        List[Dict]: Список демо-вопросов.
    """
    return DEMO_QUESTIONS

def get_all_vasini_questions() -> List[Dict[str, Union[str, Dict[str, str]]]]:
    """
    Получение полного списка вопросов Vasini.
    
    Returns:
        List[Dict]: Полный список вопросов Vasini.
    """
    # Все вопросы Vasini в одном списке
    all_vasini_questions = VASINI_QUESTIONS + VASINI_QUESTIONS_2 + [
        # Третья часть вопросов (ранее get_vasini_questions_3)
        {
            "id": "vasini_17",
            "text": "Как вы реагируете на изменения?",
            "type": "choice",
            "options": {
                "A": "Анализирую последствия и ищу логические основания",
                "B": "Обращаю внимание на то, как они влияют на людей и отношения",
                "C": "Адаптируюсь и ищу практические способы действовать в новых условиях",
                "D": "Воодушевляюсь новыми возможностями и потенциалом"
            }
        },
        {
            "id": "vasini_18",
            "text": "Что для вас означает успех?",
            "type": "choice",
            "options": {
                "A": "Интеллектуальное мастерство и компетентность",
                "B": "Гармоничные отношения и внутренняя реализация",
                "C": "Достижение целей и признание результатов",
                "D": "Творческая самореализация и уникальный вклад"
            }
        },
        {
            "id": "vasini_19",
            "text": "Как вы действуете в стрессовой ситуации?",
            "type": "choice",
            "options": {
                "A": "Анализирую ситуацию и ищу рациональное решение",
                "B": "Сосредотачиваюсь на своих чувствах и потребностях других",
                "C": "Беру ситуацию под контроль и предпринимаю конкретные шаги",
                "D": "Ищу нестандартный выход, опираясь на интуицию"
            }
        },
        {
            "id": "vasini_20",
            "text": "Что вас раздражает в других людях?",
            "type": "choice",
            "options": {
                "A": "Нелогичность, неточность, непоследовательность",
                "B": "Бесчувственность, манипуляции, отсутствие эмпатии",
                "C": "Неэффективность, нерешительность, безответственность",
                "D": "Косность мышления, отсутствие воображения, излишняя критика"
            }
        },
        {
            "id": "vasini_21",
            "text": "Что вас больше всего привлекает в работе?",
            "type": "choice",
            "options": {
                "A": "Возможность анализировать сложные проблемы",
                "B": "Шанс положительно влиять на жизни других людей",
                "C": "Достижение конкретных и измеримых результатов",
                "D": "Создание чего-то нового и уникального"
            }
        },
        {
            "id": "vasini_22",
            "text": "Как вы предпочитаете проводить свободное время?",
            "type": "choice",
            "options": {
                "A": "Изучая новые области знаний или совершенствуя навыки",
                "B": "В глубоком общении с близкими или занимаясь саморазвитием",
                "C": "Занимаясь спортом, хобби или планируя будущие цели",
                "D": "Творчески самовыражаясь или получая новые впечатления"
            }
        },
        {
            "id": "vasini_23",
            "text": "Что вас вдохновляет?",
            "type": "choice",
            "options": {
                "A": "Новые знания, открытия, понимание сложных систем",
                "B": "Глубокие человеческие истории, духовные практики",
                "C": "Истории успеха, достижения, преодоление препятствий",
                "D": "Искусство, необычные идеи, природа, возможности будущего"
            }
        },
        {
            "id": "vasini_24",
            "text": "Какой рабочей среде вы отдаете предпочтение?",
            "type": "choice",
            "options": {
                "A": "Спокойной, упорядоченной, с минимумом отвлечений",
                "B": "Гармоничной, поддерживающей, с приятной атмосферой",
                "C": "Динамичной, ориентированной на результат",
                "D": "Вдохновляющей, стимулирующей творчество"
            }
        },
        # Четвертая часть вопросов (ранее get_vasini_questions_4)
        {
            "id": "vasini_25",
            "text": "Какому виду задач вы отдаете предпочтение?",
            "type": "choice",
            "options": {
                "A": "Требующим анализа, исследования и глубокого понимания",
                "B": "Связанным с помощью людям и улучшением отношений",
                "C": "Позволяющим достичь ощутимых результатов и прогресса",
                "D": "Требующим творческого подхода и инноваций"
            }
        },
        {
            "id": "vasini_26",
            "text": "Как вы относитесь к правилам?",
            "type": "choice",
            "options": {
                "A": "Ценю их логичность и последовательность",
                "B": "Оцениваю их влияние на людей и отношения",
                "C": "Соблюдаю, если они эффективны и целесообразны",
                "D": "Готов их переосмыслить или изменить при необходимости"
            }
        },
        {
            "id": "vasini_27",
            "text": "Какая критика вас больше задевает?",
            "type": "choice",
            "options": {
                "A": "Указание на логические ошибки или некомпетентность",
                "B": "Обвинение в бесчувственности или неискренности",
                "C": "Сомнение в вашей продуктивности или эффективности",
                "D": "Ограничение вашей креативности или уникальности"
            }
        },
        {
            "id": "vasini_28",
            "text": "Что вам помогает принимать важные решения?",
            "type": "choice",
            "options": {
                "A": "Тщательный анализ фактов и логических последствий",
                "B": "Внимание к чувствам и ценностям, своим и других людей",
                "C": "Оценка практических результатов и эффективности",
                "D": "Интуиция и рассмотрение нестандартных возможностей"
            }
        },
        {
            "id": "vasini_29",
            "text": "Как вы относитесь к конфликтам?",
            "type": "choice",
            "options": {
                "A": "Стараюсь разрешить их логически, выявив причины",
                "B": "Стремлюсь к гармонии и учету чувств всех сторон",
                "C": "Предпочитаю прямое обсуждение и быстрое практическое решение",
                "D": "Ищу креативные подходы, выходящие за рамки противоречий"
            }
        },
        {
            "id": "vasini_30",
            "text": "Что вам важнее в жизни?",
            "type": "choice",
            "options": {
                "A": "Знания, компетентность, понимание",
                "B": "Гармония, аутентичность, глубокие связи",
                "C": "Достижения, результаты, эффективность",
                "D": "Творчество, самовыражение, свобода"
            }
        },
        {
            "id": "vasini_31",
            "text": "Каковы ваши природные таланты?",
            "type": "choice",
            "options": {
                "A": "Анализ, систематизация, решение сложных задач",
                "B": "Понимание людей, эмпатия, развитие отношений",
                "C": "Организация, руководство, достижение результатов",
                "D": "Генерация идей, творчество, инновационное мышление"
            }
        },
        {
            "id": "vasini_32",
            "text": "Что для вас наиболее сложно?",
            "type": "choice",
            "options": {
                "A": "Иметь дело с нелогичными эмоциями и чувствами",
                "B": "Жертвовать гармонией ради эффективности",
                "C": "Заниматься теоретизированием без практического применения",
                "D": "Следовать жестким рамкам и ограничениям"
            }
        },
        # Пятая часть вопросов (ранее get_vasini_questions_5)
        {
            "id": "vasini_33",
            "text": "Как вы ведете себя в новом коллективе?",
            "type": "choice",
            "options": {
                "A": "Наблюдаю и анализирую, прежде чем включиться",
                "B": "Стараюсь установить личный контакт и почувствовать атмосферу",
                "C": "Активно включаюсь в работу и демонстрирую компетентность",
                "D": "Проявляю индивидуальность и делюсь необычными идеями"
            }
        },
        {
            "id": "vasini_34",
            "text": "Что вам дает ощущение удовлетворения?",
            "type": "choice",
            "options": {
                "A": "Решение сложной проблемы или понимание сложной системы",
                "B": "Глубокая связь с людьми или внутренняя гармония",
                "C": "Достижение целей и преодоление препятствий",
                "D": "Создание чего-то уникального и самовыражение"
            }
        }
    ]
    
    return all_vasini_questions

def get_question_by_id(question_id: str) -> Dict[str, Union[str, Dict[str, str]]]:
    """
    Получение вопроса по его ID.
    
    Args:
        question_id: ID вопроса.
        
    Returns:
        Dict: Данные вопроса или пустой словарь, если вопрос не найден.
    """
    # Объединяем демо-вопросы и все вопросы Vasini
    all_questions = DEMO_QUESTIONS + get_all_vasini_questions()
    
    # Ищем вопрос по ID
    for question in all_questions:
        if question["id"] == question_id:
            return question
    
    # Если вопрос не найден, возвращаем пустой словарь
    return {}

def get_personality_type_from_answers(answers: Dict[str, Any]) -> Tuple[Dict[str, int], str, Optional[str]]:
    """
    Определяет тип личности по ответам на вопросы Vasini.
    
    Args:
        answers: Словарь с ответами пользователя
    
    Returns:
        Tuple[Dict[str, int], str, Optional[str]]: Кортеж с количеством ответов каждого типа, 
                                              основным типом личности и дополнительным типом (если есть)
    """
    # Счетчики для типов ответов
    type_counts = {
        "A": 0,  # Интеллектуальный тип
        "B": 0,  # Эмоциональный тип
        "C": 0,  # Практический тип
        "D": 0   # Творческий тип
    }
    
    # Подсчитываем количество ответов каждого типа
    vasini_count = 0
    for question_id, answer in answers.items():
        # Проверяем, что это вопрос Vasini (начинается с 'vasini_')
        if question_id.startswith('vasini_') and answer in ["A", "B", "C", "D"]:
            type_counts[answer] += 1
            vasini_count += 1
    
    # Логируем информацию о подсчете
    logger.info(f"Подсчитано {vasini_count} ответов на вопросы Vasini")
    logger.info(f"Распределение ответов: A ({type_counts['A']}), B ({type_counts['B']}), C ({type_counts['C']}), D ({type_counts['D']})")
    
    # Если ответов на вопросы Vasini нет, возможно структура ответов другая
    # Проверяем наличие ответов в другом формате
    if sum(type_counts.values()) == 0:
        logger.warning("Не найдены ответы в стандартном формате, пробуем альтернативный формат")
        for key, value in answers.items():
            if isinstance(value, str) and value.upper() in ["A", "B", "C", "D"]:
                type_counts[value.upper()] += 1
    
    # Находим тип с наибольшим количеством ответов
    primary_type = max(type_counts, key=type_counts.get)
    max_count = type_counts[primary_type]
    
    # Если все счетчики равны 0, устанавливаем тип по умолчанию
    if max_count == 0:
        logger.warning("Не удалось определить тип личности, используется тип по умолчанию")
        return type_counts, "Интеллектуальный", None
        
    # Название типа личности
    personality_types = {
        "A": "Интеллектуальный",
        "B": "Эмоциональный",
        "C": "Практический",
        "D": "Творческий"
    }
    
    # Находим второй по частоте тип
    type_counts_copy = type_counts.copy()
    type_counts_copy.pop(primary_type)
    secondary_type = max(type_counts_copy, key=type_counts_copy.get)
    second_max_count = type_counts_copy[secondary_type]
    
    # Если второй тип сильно отстает от первого, не учитываем его
    if second_max_count < max_count * 0.7:
        secondary_result = None
    else:
        secondary_result = personality_types[secondary_type]
    
    logger.info(f"Определен тип личности: {personality_types[primary_type]}" + 
               (f" с элементами {secondary_result}" if secondary_result else ""))
    
    return type_counts, personality_types[primary_type], secondary_result

def generate_profile_prompt(answers: Dict[str, str]) -> str:
    """
    Генерирует промт для создания психологического профиля.
    
    Args:
        answers: Словарь с ответами пользователя на вопросы
    
    Returns:
        str: Промт для генерации профиля
    """
    # Получаем информацию о типе личности
    type_counts, primary_type, secondary_type = get_personality_type_from_answers(answers)
    
    # Получаем базовую информацию о пользователе
    name = answers.get("name", "пользователь")
    age = answers.get("age", "")
    birthdate = answers.get("birthdate", "")
    birthplace = answers.get("birthplace", "")
    timezone = answers.get("timezone", "")
    
    # Формируем строку с личными данными пользователя
    personal_data = f"Личные данные пользователя:\n"
    personal_data += f"- Имя: {name}\n"
    
    if age:
        personal_data += f"- Возраст: {age}\n"
    if birthdate:
        personal_data += f"- Дата рождения: {birthdate}\n"
    if birthplace:
        personal_data += f"- Место рождения: {birthplace}\n"
    if timezone:
        personal_data += f"- Часовой пояс: {timezone}\n"
    
    # Формируем промт
    prompt = f"""Создай детальный психологический профиль для пользователя.

{personal_data}

Информация о типе личности:
- Основной тип: {primary_type}
- Дополнительный тип: {secondary_type if secondary_type else "не выявлен"}
- Распределение ответов: A ({type_counts['A']}), B ({type_counts['B']}), C ({type_counts['C']}), D ({type_counts['D']})

Структура профиля должна включать два основных раздела:

1. КРАТКИЙ ПРОФИЛЬ:
   - Личная информация пользователя
   - Тип личности с кратким описанием
   - 3-4 ключевые сильные стороны
   - 2-3 важнейшие личностные особенности

2. ДЕТАЛЬНЫЙ ПРОФИЛЬ (очень подробный и развернутый):
   - Личная информация пользователя в полном объеме
   - Детальное описание психологического типа и его особенностей
   - Подробный анализ всех сильных сторон (минимум 5-7 конкретных качеств)
   - Развернутое описание личностных особенностей (5-7 характеристик с примерами проявления)
   - Глубокий анализ зон роста (3-5 областей для развития с конкретными рекомендациями)
   - Детальные рекомендации для развития (5-7 практических советов с описанием их пользы)
   - Анализ взаимодействия с другими людьми
   - Рекомендации по профессиональной самореализации
   - Советы по достижению внутреннего баланса и благополучия

Стиль и ограничения:
- Используй научный подход, без эзотерики и астрологии
- Пиши простым, понятным языком, но с психологической глубиной
- Акцентируй внимание на сильных сторонах и потенциале
- Не используй абсолютные утверждения ("всегда", "никогда")
- Избегай диагнозов или медицинских заключений
- Используй эмодзи для структурирования текста и улучшения восприятия
- Детальный профиль должен быть обширным, глубоким и информативным
"""
    
    return prompt 