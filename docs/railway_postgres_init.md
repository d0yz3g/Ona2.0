# Настройка PostgreSQL для бота ОНА в Railway

## Введение

Бот ОНА (Осознанный Наставник и Аналитик) использует PostgreSQL в качестве базы данных при развертывании на платформе Railway. Этот документ содержит инструкции по настройке и инициализации базы данных, а также по устранению возможных проблем.

## Настройка PostgreSQL в Railway

### 1. Создание базы данных в Railway

1. В своем проекте в Railway нажмите кнопку "New" и выберите "Database" → "PostgreSQL"
2. Railway автоматически создаст новый экземпляр PostgreSQL и добавит его в ваш проект
3. После создания базы данных Railway автоматически добавит переменную окружения `DATABASE_URL` в ваш проект

### 2. Подключение бота к базе данных

Бот автоматически обнаружит переменную окружения `DATABASE_URL` и будет использовать PostgreSQL вместо SQLite.

## Инициализация таблиц в PostgreSQL

### Автоматическая инициализация

При запуске бота через `start_bot.py` происходит автоматическая проверка наличия и инициализация таблиц в PostgreSQL:

1. Бот проверяет наличие переменной окружения `DATABASE_URL`
2. Если переменная найдена, бот проверяет наличие необходимых таблиц в базе данных
3. Если таблицы отсутствуют, бот автоматически запускает скрипт `init_postgres.py` для их создания

### Ручная инициализация

Если автоматическая инициализация не сработала, вы можете выполнить инициализацию вручную:

```bash
python init_postgres.py
```

## Структура таблиц в PostgreSQL

Бот использует следующие таблицы в PostgreSQL:

1. **users** - таблица пользователей
   - `id` - первичный ключ, автоинкрементный
   - `tg_id` - уникальный Telegram ID пользователя
   - `created` - дата и время создания записи

2. **answers** - таблица ответов пользователей на вопросы
   - `id` - ID пользователя (внешний ключ к users.id)
   - `q_code` - код вопроса
   - `value` - ответ на вопрос
   - Первичный ключ: (id, q_code)

3. **profiles** - таблица психологических профилей пользователей
   - `id` - ID пользователя (внешний ключ к users.id)
   - `data` - данные профиля в формате JSON
   - `created` - дата и время создания профиля

4. **reminders** - таблица напоминаний
   - `id` - первичный ключ, автоинкрементный
   - `user_id` - ID пользователя (внешний ключ к users.id)
   - `cron` - расписание напоминания в формате cron
   - `message` - текст напоминания
   - `created` - дата и время создания напоминания

## Диагностика проблем с PostgreSQL

### Проверка подключения

Для проверки подключения к PostgreSQL запустите:

```bash
python test_postgres_connection.py
```

Скрипт проверит:
- Соединение с сервером PostgreSQL
- Наличие необходимых таблиц
- Структуру таблиц

### Резервное копирование базы данных

Для создания резервной копии базы данных:

```bash
python backup_postgres.py
```

Файл резервной копии будет сохранен в директории `backups/` с именем `ona_bot_db_backup_YYYYMMDD_HHMMSS.sql`.

### Типичные проблемы и их решение

1. **Ошибка "No module named 'psycopg2'"**
   
   Необходимо установить пакет `psycopg2-binary`:
   ```bash
   pip install psycopg2-binary
   ```

2. **Ошибка "password authentication failed"**
   
   Проверьте правильность строки подключения `DATABASE_URL`. В Railway вы можете найти правильную строку в разделе "Connect" вашей базы данных.

3. **Ошибка "could not connect to server"**
   
   Убедитесь, что ваша база данных запущена и доступна. В Railway проверьте статус вашей базы данных.

4. **Таблицы не создаются автоматически**
   
   Запустите инициализацию вручную:
   ```bash
   python init_postgres.py
   ```

## Миграция с SQLite на PostgreSQL

Если вы уже использовали бота с SQLite и хотите перейти на PostgreSQL:

1. Создайте базу данных PostgreSQL в Railway
2. Инициализируйте таблицы в PostgreSQL:
   ```bash
   python init_postgres.py
   ```
3. Создайте резервную копию данных из SQLite
4. Импортируйте данные в PostgreSQL

## Дополнительные ресурсы

- [Документация PostgreSQL](https://www.postgresql.org/docs/)
- [Документация Railway по PostgreSQL](https://docs.railway.app/databases/postgresql)
- [Документация psycopg2](https://www.psycopg.org/docs/) 