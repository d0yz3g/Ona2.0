# Проверка работы PostgreSQL в проекте ONA

В этом документе описано, как проверить, что PostgreSQL корректно интегрирован с вашим Telegram-ботом и данные правильно сохраняются в базе данных.

## 1. Проверка наличия переменной окружения

1. Убедитесь, что переменная окружения `DATABASE_URL` корректно установлена:

```bash
python test_postgres_connection.py
```

Если вы видите сообщение "✅ Соединение с PostgreSQL успешно установлено", значит, всё настроено правильно.

## 2. Проверка работы бота с PostgreSQL

1. Запустите бота:

```bash
python main.py
```

2. В логах бота при запуске вы должны увидеть сообщение:
   ```
   INFO: Обнаружена переменная DATABASE_URL: PostgreSQL будет использоваться как база данных
   ```

3. Проверьте в логах сообщения о создании таблиц:
   ```
   INFO: Инициализация PostgreSQL по адресу: postgres://...
   ```

## 3. Тестирование сохранения и загрузки данных

1. Отправьте боту команду `/start`

2. Пройдите опрос, отвечая на вопросы.

3. После завершения опроса в логах вы должны увидеть:
   ```
   INFO: Профиль id=1 сохранен для пользователя 123456789
   INFO: Создана резервная копия базы данных: data/backups/backup_YYYYMMDD_HHMMSS.sql
   ```

4. Перезапустите бота (остановите и запустите заново).

5. Отправьте команду `/profile` - бот должен загрузить ваш профиль из базы данных PostgreSQL.

6. Если профиль загружен корректно, вы увидите в логах:
   ```
   INFO: Профиль загружен из базы данных для пользователя 123456789
   ```

## 4. Проверка таблиц в базе данных Railway

1. Откройте проект в Railway, перейдите в раздел "Data" вашей PostgreSQL базы данных.

2. Вы должны увидеть таблицы:
   - `users` - информация о пользователях
   - `answers` - ответы пользователей на вопросы
   - `profiles` - профили пользователей
   - `reminders` - напоминания

3. Вы можете выполнить запрос для проверки данных:
   ```sql
   SELECT * FROM users;
   SELECT * FROM profiles;
   ```

## 5. Резервное копирование данных

Бот автоматически создает резервные копии базы данных при сохранении профиля пользователя.

1. Проверьте наличие файлов бэкапа в папке `data/backups/`.

2. Файлы бэкапов имеют формат `backup_YYYYMMDD_HHMMSS.sql` для SQLite или `.dump` для PostgreSQL.

## Решение проблем

- **Ошибка подключения к PostgreSQL**: проверьте правильность строки подключения (DATABASE_URL).
  
- **Таблицы не создаются**: проверьте права доступа пользователя PostgreSQL.
  
- **Данные не сохраняются**: проверьте логи на наличие ошибок при выполнении SQL-запросов.

- **Ошибка "psycopg2 not found"**: установите драйвер PostgreSQL:
  ```bash
  pip install psycopg2-binary
  ``` 